## Specifications

### Project structure

If you look into the directory generated by stone by default, you'll
have:

    ├── stone.toml
    ├── templates
    │   └── template.html
    └── pages
        ├── index.md
        └── static
            └── style.css

* The `stone.toml` file describes the configuration of your
project. It defines its name, the pages you want to have in the title
bar, and *processing rules* used for generating the pages.
* The `templates` directory contains html *templates* that can be used
  to generate the pages, providing a reusable page structure in which
  page content can be inserted.
* The `pages` directory is where you write the pages with your
  content. They are processed by the rules specified in the config. 

After running `stone`, the static pages are generated in a new
directory :

    └── site
        ├── index.html
        └── static
            └── style.css

The `site` directory contains the generated content: what you want to
send online to be served by your web server.

### Header bar

Stone allows you to specify a list of pages that should appear in a website
"header bar". This is done using the `header` setting, for instance:

```
header = ["index.html", "about.html"]
```

The elements of `header` should be file paths relative to `site/`.

This results in stone generating a HTML snippet for the header, which is then
inserted in the [template `BAR` variable](#templates).

### Page titles

Stone assigns a title to each page, inserted in the [template `PAGE_TITLE`
variable](#templates). 

By default, a page's title is the name of the file (in `site/`) after removing
the extension. But this can also be overrided in the configuration file in the
`page_title` table:

```
[page_title]
"index.html" = "My homepage"
```

The `[page_title]` table maps file paths in `site/` to their page title.

### Rules

Files in `pages/` are processed according to the list of rules specified in the
`stone.toml` configuration file.

#### Definition

A rule is specified by defining a `[[rules]]` entry of the form:

```
[[rules]]
source = "<source pattern>"
target = "<target pattern>"
template = "<path to template file>" # optional
kind = "<rule kind>"
... # possibly other settings depending on the kind 
```

This defines:
- `source`: the file paths that this rule applies to. This will be matched
  against the paths of the files in the `path` directory, relative to `path/`.
  Here, `<source pattern>` uses Bos' [pattern
  syntax](https://erratique.ch/software/bos/doc/Bos/Pat/index.html) which allows
  matching on the file using pattern variables. **Example:** `source =
  "$(base).md"` to match on all `.md` files.
- `target`: the destination file in `site` where the output of the rule should
  be written to. This also follows Bos' pattern syntax and can refer to the
  variables matched in `source`; variables will be replaced by their contents
  (`target` must only use variables used by `source`). **Example:** `target =
  "$(base).html"` to turn `page/foo.md` into `site/foo.html`.
- `template`: the path to a file in the `templates/` directory, relative to that
  directory. The output of the rule will be inserted in this template before
  being written to `target`. This parameter is optional; if absent, the
  preprocessed contents will be output as-is. See [Templates](#templates) for
  more details on the structure of templates.
- `kind`: how the rule should process the input file.
  + `builtin_markdown`: use the builtin engine to parse the input as markdown
    and output html, see [Markdown engine](#markdown-engine) for more details. 
  + `external_commal`: use an external command to process the input file. Reads
    the additional parameter:
    * `command = "<command ... $(source) ...>"`: a shell command (as a Bos
      pattern), which can use the `$(source)` variable to refer to the input
      file, and must write its output to standard output. **Example:** `command
      = "asciidoc -b html -s -o - $(source)"`.

**If several rules match** a given input file, they are all applied in the order
of their definition in the configuration file (from top to bottom).

**If no rules match** an input file, the file is copied as-is to `site/`.

#### Examples

##### Markdown

Process markdown files and insert the result in the template `template.html`.

This is the default rule included in the `stone.toml` configuration generated by
`stone -i`. The template file `template.html` is also generated by `stone -i`.

```
[[rules]]
kind = "builtin_markdown"
source = "$(base).md"
target = "$(base).html"
template = "template.html"
```

##### Asciidoc

Process asciidoc files using the external `asciidoc` program, inserting the
result in a custom template `asciidoc-template.html`:

```
[[rules]]
kind = "external_command"
source = "$(base).adoc"
target = "$(base).html"
template = "asciidoc-template.html"
command = "asciidoc -b html -s -o - $(source)"
```

##### Embed raw HTML in a template 

Include `.embed.html` files in the default template as-is.

```
[[rules]]
kind = "external_command"
source = "$(base).embed.html"
target = "$(base).html"
template = "template.html"
command = "cat $(source)"
```

### Templates

Templates are arbitrary text files. Templates can contain *variables* that will
be replaced during the pages generation:

* `SITE_TITLE`: replaced by the website title specified with the `title`
  parameter in `stone.toml`;
* `PAGE_TITLE`: will be replaced by the [page's title](#page-titles).
* `BAR`: replaced by a HTML snippet linking to the [header pages](#header-bar).
* `PATH_TO_ROOT`: a relative path from the current page to the root of the
  website. Useful to refer to other files. For instance, to refer to
  `static/style.css`, use `$PATH_TO_ROOT$static/style.css`.
* `CONTENT`: the content of the page itself, generated after applying the
  processing [rules](#rules).

In the template file, the syntax to refer to a variable is to wrap it between
`$`. For instance, the template file should refer to `$CONTENT$`, `$SITE_TITLE$`
etc.

### Markdown engine

The internal markdown engine uses the
[Cmarkit](https://erratique.ch/software/cmarkit/doc/) library which implements
the [Commonmark](https://spec.commonmark.org/0.30/) specification.

The library is configured with the following settings:
- [extensions](https://erratique.ch/software/cmarkit/doc/Cmarkit/index.html#extensions) are enabled;
- Raw HTML snippets are allowed (Cmarkit's "safe" mode is disabled)
- Headings have an automatically generated html id, which can be used as anchor in links. 
  For instance, `## Hello world` will produce `<h2 id='hello-world'>...</h2>`.
